---
title: 'Configure Auth Hooks'
description: 'Set up auth hooks for self-hosted Supabase with Docker.'
subtitle: 'Set up auth hooks for self-hosted Supabase with Docker.'
---

This guide covers the **server-side configuration** required to enable auth hooks on a self-hosted Supabase instance running with Docker Compose. Auth hooks let you run custom logic at specific points in the authentication flow — for example, adding claims to JWTs, sending SMS through a custom provider, or restricting signups.

For hook implementation details (input/output schemas, SQL and HTTP examples), see [Auth Hooks](/docs/guides/auth/auth-hooks).

## Before you begin

You need:

- A working self-hosted Supabase installation. See [Self-Hosting with Docker](/docs/guides/self-hosting/docker).
- For Postgres function hooks: access to the Supabase database to create functions.
- For HTTP endpoint hooks: a reachable HTTPS endpoint or a local Edge Function.

## How hooks work

The Auth service (GoTrue) can call a **hook** at specific lifecycle events during authentication. Each hook is configured with three environment variables:

- `GOTRUE_HOOK_{HOOK_NAME}_ENABLED` — enable the hook (`true`/`false`)
- `GOTRUE_HOOK_{HOOK_NAME}_URI` — the hook endpoint
- `GOTRUE_HOOK_{HOOK_NAME}_SECRETS` — webhook signing secrets (for HTTP hooks)

### URI schemes

Hooks support two URI schemes:

| Scheme | Format | When to use |
|--------|--------|-------------|
| `pg-functions://` | `pg-functions://postgres/schema/function_name` | Postgres functions (recommended for self-hosted) |
| `https://` | `https://example.com/hook` | External HTTP endpoints |

<Admonition type="tip">

Postgres function hooks run inside your database — no network overhead, no secrets required. They are the simplest option for self-hosted setups.

</Admonition>

<Admonition type="note">

`http://` URIs are only allowed for `localhost`, `127.0.0.1`, `::1`, and `host.docker.internal`. For production HTTP hooks, use `https://`.

</Admonition>

### The two-file requirement

<Admonition type="caution">

Adding variables to `.env` alone does **nothing** for the auth container. You must also uncomment or add the passthrough in `docker-compose.yml`.

</Admonition>

Docker Compose only forwards environment variables that are explicitly listed in a service's `environment:` block. You must:

1. Define the variable value in `.env`
2. Reference it in the `auth` service's `environment:` block in `docker-compose.yml`

## Available hooks

| Hook | Env name | Description | Plan |
|------|----------|-------------|------|
| [Custom Access Token](/docs/guides/auth/auth-hooks/custom-access-token-hook) | `CUSTOM_ACCESS_TOKEN` | Add claims to JWTs before they are issued | Free, Pro |
| [Send SMS](/docs/guides/auth/auth-hooks/send-sms-hook) | `SEND_SMS` | Replace built-in SMS sending with a custom provider | Free, Pro |
| [Send Email](/docs/guides/auth/auth-hooks/send-email-hook) | `SEND_EMAIL` | Replace built-in email sending with a custom provider | Free, Pro |
| [Before User Created](/docs/guides/auth/auth-hooks/before-user-created-hook) | `BEFORE_USER_CREATED` | Run checks or block signups before creating a user | Free, Pro |
| [MFA Verification](/docs/guides/auth/auth-hooks/mfa-verification-hook) | `MFA_VERIFICATION_ATTEMPT` | Validate MFA attempts (rate limit, brute-force protection) | Teams, Enterprise |
| [Password Verification](/docs/guides/auth/auth-hooks/password-verification-hook) | `PASSWORD_VERIFICATION_ATTEMPT` | Track and limit failed password attempts | Teams, Enterprise |

## Step-by-step: Postgres function hook

This example enables the **Custom Access Token** hook using a Postgres function that adds a `user_role` claim to the JWT.

### 1. Create the Postgres function

Connect to your database and run:

```sql name=custom_access_token_hook.sql
create or replace function public.custom_access_token_hook(event jsonb)
returns jsonb
language plpgsql
security definer
set search_path = ''
as $$
declare
  claims jsonb;
  user_role text;
begin
  claims := event->'claims';

  -- Example: look up a custom role from a user_roles table
  select role into user_role
    from public.user_roles
    where user_id = (event->>'user_id')::uuid;

  if user_role is not null then
    claims := jsonb_set(
      claims, '{user_role}', to_jsonb(user_role)
    );
  end if;

  -- Return the modified claims
  return jsonb_build_object('claims', claims);
end;
$$;

-- Grant execute permission to supabase_auth_admin
grant execute on function public.custom_access_token_hook
  to supabase_auth_admin;

-- Revoke from public and other roles
revoke execute on function public.custom_access_token_hook
  from authenticated, anon, public;
```

### 2. Uncomment the hook in `docker-compose.yml`

In the `auth` service `environment:` block, uncomment:

```yaml name=docker-compose.yml
GOTRUE_HOOK_CUSTOM_ACCESS_TOKEN_ENABLED: "true"
GOTRUE_HOOK_CUSTOM_ACCESS_TOKEN_URI: "pg-functions://postgres/public/custom_access_token_hook"
```

<Admonition type="note">

Postgres function hooks do not require secrets — the function runs inside the database with direct access.

</Admonition>

### 3. Restart the auth service

```sh
docker compose up -d auth
```

### 4. Verify

Check the auth container logs for errors:

```sh
docker compose logs auth --tail 20
```

Then sign in and decode the JWT to confirm your custom claims appear.

## Step-by-step: HTTP endpoint hook

This example enables the **Send Email** hook using an Edge Function.

### 1. Create the Edge Function

Create `volumes/functions/email_sender/index.ts`:

```ts name=volumes/functions/email_sender/index.ts
import { Webhook } from 'https://esm.sh/standardwebhooks@1.0.0'

const hookSecret = Deno.env.get('SEND_EMAIL_HOOK_SECRET')!

Deno.serve(async (req) => {
  // Verify the webhook signature
  const payload = await req.text()
  const headers = Object.fromEntries(req.headers)
  const wh = new Webhook(hookSecret)
  const event = wh.verify(payload, headers) as {
    user: Record<string, unknown>
    email_data: Record<string, unknown>
  }

  // Send email using your provider
  // ... your email sending logic here ...

  return new Response(JSON.stringify({}), {
    headers: { 'Content-Type': 'application/json' },
  })
})
```

### 2. Generate a webhook secret

```sh
# Generate a base64 secret and format it
SECRET=$(openssl rand -base64 32)
echo "v1,whsec_${SECRET}"
```

Copy the output (e.g., `v1,whsec_abc123...`).

### 3. Configure in `.env`

```bash name=.env
HOOK_SEND_EMAIL_URI=http://host.docker.internal:8000/functions/v1/email_sender
HOOK_SEND_EMAIL_SECRETS=v1,whsec_your-generated-secret
```

### 4. Uncomment in `docker-compose.yml`

```yaml name=docker-compose.yml
GOTRUE_HOOK_SEND_EMAIL_ENABLED: "true"
GOTRUE_HOOK_SEND_EMAIL_URI: ${HOOK_SEND_EMAIL_URI}
GOTRUE_HOOK_SEND_EMAIL_SECRETS: ${HOOK_SEND_EMAIL_SECRETS}
```

### 5. Restart

```sh
docker compose up -d auth functions
```

## Hook-specific setup

<Tabs
  scrollable
  size="small"
  type="underlined"
  defaultActiveId="custom-access-token"
>

<TabPanel id="custom-access-token" label="Custom Access Token">

Runs before a token is issued. Use it to add custom claims to the JWT.

**`docker-compose.yml`:**

```yaml name=docker-compose.yml
GOTRUE_HOOK_CUSTOM_ACCESS_TOKEN_ENABLED: "true"
GOTRUE_HOOK_CUSTOM_ACCESS_TOKEN_URI: "pg-functions://postgres/public/custom_access_token_hook"
```

The function receives `user_id`, `claims`, and `authentication_method`. It must return a `claims` object containing all required JWT fields (`aud`, `exp`, `iat`, `sub`, `role`, `aal`, `session_id`, `email`, `phone`, `is_anonymous`).

See [Custom Access Token Hook](/docs/guides/auth/auth-hooks/custom-access-token-hook) for full input/output schemas and examples.

</TabPanel>

<TabPanel id="send-sms" label="Send SMS">

Replaces built-in SMS sending. Use it to send OTPs through a custom provider (e.g., Termii, regional SMS gateways, WhatsApp).

**`.env`:**

```bash name=.env
HOOK_SEND_SMS_URI=pg-functions://postgres/public/send_sms_hook
HOOK_SEND_SMS_SECRETS=
```

**`docker-compose.yml`:**

```yaml name=docker-compose.yml
GOTRUE_HOOK_SEND_SMS_ENABLED: "true"
GOTRUE_HOOK_SEND_SMS_URI: ${HOOK_SEND_SMS_URI}
GOTRUE_HOOK_SEND_SMS_SECRETS: ${HOOK_SEND_SMS_SECRETS}
```

The function receives a `user` object and `sms.otp`. Return an empty JSON object `{}` on success.

See [Send SMS Hook](/docs/guides/auth/auth-hooks/send-sms-hook) for full input/output schemas and examples.

</TabPanel>

<TabPanel id="send-email" label="Send Email">

Replaces built-in email sending. Use it to send emails through a custom provider (e.g., Resend, SendGrid) or customize templates.

**`.env`:**

```bash name=.env
HOOK_SEND_EMAIL_URI=http://host.docker.internal:8000/functions/v1/email_sender
HOOK_SEND_EMAIL_SECRETS=v1,whsec_your-secret
```

**`docker-compose.yml`:**

```yaml name=docker-compose.yml
GOTRUE_HOOK_SEND_EMAIL_ENABLED: "true"
GOTRUE_HOOK_SEND_EMAIL_URI: ${HOOK_SEND_EMAIL_URI}
GOTRUE_HOOK_SEND_EMAIL_SECRETS: ${HOOK_SEND_EMAIL_SECRETS}
```

The function receives a `user` object and `email_data` with `token`, `token_hash`, `redirect_to`, and `email_action_type`.

See [Send Email Hook](/docs/guides/auth/auth-hooks/send-email-hook) for full input/output schemas and examples.

</TabPanel>

<TabPanel id="before-user-created" label="Before User Created">

Runs before a new user is created. Use it to restrict signups by domain, block specific OAuth providers, or enforce IP-based access control.

**`docker-compose.yml`:**

```yaml name=docker-compose.yml
GOTRUE_HOOK_BEFORE_USER_CREATED_ENABLED: "true"
GOTRUE_HOOK_BEFORE_USER_CREATED_URI: "pg-functions://postgres/public/before_user_created"
```

The function receives a `user` object. To block the signup, return a JSON object with `decision` set to `reject` and a `message`.

See [Before User Created Hook](/docs/guides/auth/auth-hooks/before-user-created-hook) for full input/output schemas and examples.

</TabPanel>

<TabPanel id="mfa-verification" label="MFA Verification">

Runs when a user attempts MFA verification. Use it to implement rate limiting or brute-force protection.

**`docker-compose.yml`:**

```yaml name=docker-compose.yml
GOTRUE_HOOK_MFA_VERIFICATION_ATTEMPT_ENABLED: "true"
GOTRUE_HOOK_MFA_VERIFICATION_ATTEMPT_URI: "pg-functions://postgres/public/mfa_verification_hook"
```

See [MFA Verification Hook](/docs/guides/auth/auth-hooks/mfa-verification-hook) for full input/output schemas.

</TabPanel>

<TabPanel id="password-verification" label="Password Verification">

Runs when a user attempts password verification. Use it to track failed attempts and lock accounts after too many failures.

**`docker-compose.yml`:**

```yaml name=docker-compose.yml
GOTRUE_HOOK_PASSWORD_VERIFICATION_ATTEMPT_ENABLED: "true"
GOTRUE_HOOK_PASSWORD_VERIFICATION_ATTEMPT_URI: "pg-functions://postgres/public/password_verification_hook"
```

See [Password Verification Hook](/docs/guides/auth/auth-hooks/password-verification-hook) for full input/output schemas.

</TabPanel>

</Tabs>

## Webhook secrets

HTTP hooks use the [Standard Webhooks](https://www.standardwebhooks.com/) specification for payload signing.

### Generating a secret

```sh
SECRET=$(openssl rand -base64 32)
echo "v1,whsec_${SECRET}"
```

### Secret format

- **Symmetric**: `v1,whsec_[base64]{32-88 characters}`
- **Asymmetric**: `v1a,whpk_[base64]:whsk_[base64]`

### Key rotation

Separate multiple secrets with `|` to rotate keys without downtime:

```bash name=.env
HOOK_SEND_EMAIL_SECRETS=v1,whsec_new-secret|v1,whsec_old-secret
```

The Auth service tries each secret in order. Once all clients are using the new secret, remove the old one.

<Admonition type="note">

Postgres function hooks (`pg-functions://` URIs) do not require secrets — they run directly inside the database.

</Admonition>

## Configuring phone/SMS and MFA

The default `docker-compose.yml` and `.env.example` include commented-out placeholders for SMS provider configuration and MFA settings. These are closely related to the Send SMS hook.

### SMS provider settings

If you use a built-in SMS provider (not a Send SMS hook), configure these in `.env`:

```bash name=.env
SMS_PROVIDER=twilio
SMS_OTP_EXP=60
SMS_OTP_LENGTH=6
SMS_MAX_FREQUENCY=60s
SMS_TEMPLATE=Your code is {{ .Code }}

## Twilio credentials
SMS_TWILIO_ACCOUNT_SID=your-account-sid
SMS_TWILIO_AUTH_TOKEN=your-auth-token
SMS_TWILIO_MESSAGE_SERVICE_SID=your-message-service-sid
```

And uncomment the matching `GOTRUE_SMS_*` lines in `docker-compose.yml`.

| Variable | Default | Description |
|----------|---------|-------------|
| `SMS_PROVIDER` | `twilio` | SMS provider: `twilio`, `twilio_verify`, `messagebird`, `textlocal`, `vonage` |
| `SMS_OTP_EXP` | `60` | OTP expiration in seconds |
| `SMS_OTP_LENGTH` | `6` | OTP code length (6-10 digits) |
| `SMS_MAX_FREQUENCY` | `60s` | Minimum interval between SMS sends to the same number |
| `SMS_TEMPLATE` | — | Message template (use `{{ .Code }}` for the OTP) |
| `SMS_TEST_OTP` | — | Test phone-to-OTP mappings for development (format: `phone1:code1,phone2:code2`) |

<Admonition type="tip">

If you use a **Send SMS hook** instead of a built-in provider, the hook replaces the provider entirely — you do not need to configure `SMS_PROVIDER` or provider-specific credentials. You still need `SMS_OTP_EXP` and `SMS_OTP_LENGTH` since those control how the OTP is generated and validated.

</Admonition>

### MFA settings

To change MFA defaults, uncomment in `.env`:

```bash name=.env
## TOTP (authenticator apps) — enabled by default
MFA_TOTP_ENROLL_ENABLED=true
MFA_TOTP_VERIFY_ENABLED=true

## Phone MFA — disabled by default, opt-in
MFA_PHONE_ENROLL_ENABLED=true
MFA_PHONE_VERIFY_ENABLED=true

## WebAuthn (hardware keys) — disabled by default, opt-in
MFA_WEB_AUTHN_ENROLL_ENABLED=true
MFA_WEB_AUTHN_VERIFY_ENABLED=true
```

And uncomment the matching `GOTRUE_MFA_*` lines in `docker-compose.yml`.

## Troubleshooting

### Hook not firing

- Check that `GOTRUE_HOOK_{HOOK_NAME}_ENABLED` is set to `"true"` (as a string) in `docker-compose.yml`
- Verify the variable reaches the container: `docker compose exec auth env | grep GOTRUE_HOOK`
- Remember: `.env` variables do not reach the container unless passed through in `docker-compose.yml`

### `pg-functions://` URI errors

The URI format must be exactly `pg-functions://postgres/schema/function_name`:

- The host must be `postgres`
- Schema and function name must be valid PostgreSQL identifiers
- The function must exist and be granted to `supabase_auth_admin`

### HTTP hook returns errors

Check auth logs for details:

```sh
docker compose logs auth --tail 50
```

Common causes:

- The endpoint is not reachable from the auth container
- `http://` is only allowed for `localhost`, `127.0.0.1`, `::1`, and `host.docker.internal`
- For production, use `https://`

### Webhook secret format mismatch

Secrets must match the Standard Webhooks format:

- Symmetric: `v1,whsec_[base64]` (32-88 base64 characters after the prefix)
- No spaces or newlines in the secret string
- Generate with: `echo "v1,whsec_$(openssl rand -base64 32)"`

### Permission denied on Postgres function

Ensure the function is granted to `supabase_auth_admin`:

```sql
grant execute on function public.your_hook_function
  to supabase_auth_admin;
```

### OTP expires too quickly

The default `SMS_OTP_EXP` is 60 seconds. If users report OTPs expiring before they can enter them, increase it:

```bash name=.env
SMS_OTP_EXP=300
```

Remember to also uncomment `GOTRUE_SMS_OTP_EXP: ${SMS_OTP_EXP}` in `docker-compose.yml` and restart the auth service.

## Environment variable reference

All hook-related environment variables for the `auth` service in `docker-compose.yml`:

| Variable | Description |
|----------|------------|
| `GOTRUE_HOOK_{HOOK}_ENABLED` | Enable the hook (`"true"`/`"false"`) |
| `GOTRUE_HOOK_{HOOK}_URI` | Hook endpoint (pg-functions:// or https://) |
| `GOTRUE_HOOK_{HOOK}_SECRETS` | Webhook signing secrets (HTTP hooks only) |
| `GOTRUE_SMS_PROVIDER` | SMS provider name |
| `GOTRUE_SMS_OTP_EXP` | OTP expiration in seconds |
| `GOTRUE_SMS_OTP_LENGTH` | OTP digit count (6-10) |
| `GOTRUE_SMS_MAX_FREQUENCY` | Min interval between SMS sends |
| `GOTRUE_SMS_TEMPLATE` | SMS message template |
| `GOTRUE_SMS_TEST_OTP` | Test phone:OTP mappings |
| `GOTRUE_MFA_TOTP_ENROLL_ENABLED` | Allow TOTP enrollment |
| `GOTRUE_MFA_TOTP_VERIFY_ENABLED` | Allow TOTP verification |
| `GOTRUE_MFA_PHONE_ENROLL_ENABLED` | Allow phone MFA enrollment |
| `GOTRUE_MFA_PHONE_VERIFY_ENABLED` | Allow phone MFA verification |
| `GOTRUE_MFA_WEB_AUTHN_ENROLL_ENABLED` | Allow WebAuthn enrollment |
| `GOTRUE_MFA_WEB_AUTHN_VERIFY_ENABLED` | Allow WebAuthn verification |
| `GOTRUE_MFA_MAX_ENROLLED_FACTORS` | Max MFA factors per user (default: 10) |
